================================================================================
                   QEMU 配置修复 - 完整总结
================================================================================

问题描述：运行 ./quickstart.sh 时出现 QEMU 错误

ERROR 1: ROM 地址冲突
────────────────────
qemu-system-riscv64: Some ROM regions are overlapping
  OpenSBI firmware:  0x80000000 - 0x80042a98
  tg-ch18 kernel:    0x80000000 - 0x800000ae

根本原因：QEMU 自动加载 OpenSBI，与内核地址冲突

✅ 修复方法：添加 -bios none 禁用默认 OpenSBI


ERROR 2: Virtio 块设备初始化失败
──────────────────────────────
panicked at src/virtio_block.rs:19:22:
Error when creating MmioTransport: ZeroDeviceId

根本原因：虚拟块设备没有连接到正确的 MMio 总线

✅ 修复方法：
  - 驱动器使用: -drive file=...,if=none,format=raw,id=x0
  - 设备指定:   -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0


================================================================================
                        修复前后对比
================================================================================

❌ 修复前（错误）：
  qemu-system-riscv64 \
    -machine virt \
    -m 64M \
    -kernel "$KERNEL" \
    -drive file="$FS_IMG",if=virtio,format=raw \
    -nographic

✅ 修复后（正确）：
  qemu-system-riscv64 \
    -machine virt \
    -m 64M \
    -bios none \
    -drive file="$FS_IMG",if=none,format=raw,id=x0 \
    -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0 \
    -kernel "$KERNEL" \
    -nographic


================================================================================
                          修改的文件
================================================================================

1. test-qemu.sh
   ✓ 添加 -bios none
   ✓ 修改 -drive 参数为 if=none,id=x0
   ✓ 添加 -device virtio-blk-device 指定 MMio 总线

2. run-in-qemu-system.sh
   ✓ 5 处修改（interactive + 4 个测试模式）
   ✓ 所有 QEMU 调用使用相同配置


================================================================================
                        验证和测试结果
================================================================================

✅ 内核启动成功：
   [ INFO] MMIO range -> 0x10001000..0x10002000
   [ INFO] found a block device of size 65536KB

✅ 块设备初始化：
   [ INFO] device features: SEG_MAX | GEOMETRY | BLK_SIZE | ...

✅ 用户程序执行：
   Usertests: Running 00hello_world
   Usertests: Running 05write_a
   ...

✅ 快速启动能力：
   编译: ~5 秒
   打包: ~30 秒
   QEMU启动: ~2 秒
   用户程序: 立即运行


================================================================================
                          使用方法
================================================================================

最简单的方式（推荐）：
  $ cd /home/chyyuu/thecodes/os-compare/tg-ch18/linux-compatible-tests
  $ ./quickstart.sh

手动方式：
  $ ./test-qemu.sh                      # 快速启动
  $ ./run-in-qemu-system.sh interactive # 交互式
  $ ./run-in-qemu-system.sh ch18_file0  # 运行特定测试


在 QEMU 中运行测试程序：
  > ls              # 查看文件
  > ./ch18_file0    # 基本 I/O 测试
  > ./ch18_file1    # 文件元数据测试
  > ./ch18_file2    # 硬链接测试
  > ./ch18_file3    # 批量操作测试

退出 QEMU：
  按 Ctrl-A X（或 Ctrl-A H 获取帮助）


================================================================================
                        关键参数说明
================================================================================

-machine virt
  → 虚拟机械类型

-bios none
  → 禁用默认 OpenSBI 固件加载
  → 允许内核直接启动
  → 解决地址冲突

-drive file=...,if=none,format=raw,id=x0
  → 定义块驱动器
  → if=none: 未自动附加
  → id=x0: 唯一标识符

-device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0
  → 创建虚拟块设备
  → drive=x0: 关联驱动器
  → bus=virtio-mmio-bus.0: 连接到正确的 MMio 总线
  → 这是最关键的修复！

-kernel "$KERNEL"
  → 加载内核

-nographic
  → 禁用图形，仅使用终端


================================================================================
                          故障排除
================================================================================

仍出现"overlapping ROM"错误？
  □ 确认 -bios none 在命令中
  □ 检查 test-qemu.sh 中包含该参数
  □ QEMU 版本 >= 9.0

仍然 ZeroDeviceId 错误？
  □ 确认 -device 参数中有 bus=virtio-mmio-bus.0
  □ 确认 -drive 使用 if=none 而不是 if=virtio
  □ 仔细检查参数拼写

fs.img 不存在？
  □ 运行: ./pack-to-fsimg.sh
  □ 验证: ls tg-ch18/target/riscv64gc-unknown-none-elf/debug/fs.img

程序无法在 QEMU 中找到？
  □ 运行过 pack-to-fsimg.sh 吗？
  □ 使用 ls 检查文件是否存在
  □ 检查 cases.toml 是否更新


================================================================================
                        文档参考
================================================================================

详细文档按优先级：
  1. QEMU_QUICK_REF.md        - 快速参考（开始这里）
  2. QEMU_CONFIG_FIXED.md     - 完整修复报告
  3. TG_CH18_KERNEL_TESTING.md - 详细集成指南
  4. README.md                - 项目概述


================================================================================
                        状态确认
================================================================================

✅ 问题识别：已完成
✅ 根本原因分析：已完成
✅ 修复实施：已完成
✅ 脚本更新：已完成
✅ 测试验证：已完成
✅ 文档编写：已完成

修复日期：2026-02-05
环境：Linux RISC-V64 + QEMU 10.2.0
测试状态：✅ 所有测试通过


================================================================================
